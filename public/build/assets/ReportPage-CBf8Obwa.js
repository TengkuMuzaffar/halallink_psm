import{z as M,N as oe,_ as x,r as d,G as q,c as h,a,w as B,t as m,v as j,b as z,F as U,j as W,e as T,o as u,n as A,y as $,M as V,f as N,B as se,k as S,g as I,d as ne,O as re,s as Y,x as le,h as ie}from"./main-BpaYbEPg.js";import{R as G}from"./ResponsiveTable-B0dEHhy-.js";import{m as f}from"./modal-ByxZIVwL.js";import"./LoadingSpinner-9sKMkQ1j.js";const P=()=>{const n=oe.state.user;return n&&n.company?`/api/reports/${n.company.company_type}`:"/api/reports/admin"},de=async(n={})=>{try{const e=P();return await M.get(e,{params:n})}catch(e){throw console.error("Error fetching report validities:",e),e}},ce=async n=>{try{const e=P();return await M.get(`${e}/${n}`)}catch(e){throw console.error(`Error fetching report validity ${n}:`,e),e}},me=async n=>{try{const e=P();return await M.post(e,n)}catch(e){throw console.error("Error creating report validity:",e),e}},pe=async(n,e)=>{try{const s=P();return await M.put(`${s}/${n}`,e)}catch(s){throw console.error(`Error updating report validity ${n}:`,s),s}},ue=async n=>{try{const e=P();return await M.delete(`${e}/${n}`)}catch(e){throw console.error(`Error deleting report validity ${n}:`,e),e}},ve=async(n="")=>{try{return await M.get("/api/companies",{params:{company_type:"sme",search:n}})}catch(e){throw console.error("Error fetching SME companies:",e),e}},fe=n=>{const e=document.createElement("a");e.href=`/report-pdf/${n}`,e.target="_blank",document.body.appendChild(e),e.click(),document.body.removeChild(e)},D={getReportValidities:de,getReportValidity:ce,createReportValidity:me,updateReportValidity:pe,deleteReportValidity:ue,getSmeCompanies:ve,downloadReportPdf:fe},be={name:"CompanySearchAndSelection",props:{searchLabel:{type:String,default:"Search SME Companies"},searchPlaceholder:{type:String,default:"Search by name..."},selectedLabel:{type:String,default:"Selected Companies"},resultsLabel:{type:String,default:"Search Results"},initialSelectedCompanies:{type:Array,default:()=>[]}},emits:["update:selectedCompanies"],setup(n,{emit:e}){const s=d(""),t=d([]),c=d([...n.initialSelectedCompanies]),b=d(!1);q(c,y=>{e("update:selectedCompanies",y)},{deep:!0});const l=y=>c.value.some(g=>g.companyID===y.companyID),r=y=>{l(y)||c.value.push(y)},w=y=>{c.value=c.value.filter(g=>g.companyID!==y.companyID)};let o;return q(s,y=>{if(clearTimeout(o),y.length<2){t.value=[];return}b.value=!0,o=setTimeout(async()=>{try{const g=await D.getSmeCompanies(y);t.value=g.data}catch(g){console.error("Error searching companies:",g),t.value=[]}finally{b.value=!1}},500)}),{searchQuery:s,searchResults:t,selectedCompanies:c,loading:b,isCompanySelected:l,addCompany:r,removeCompany:w,reset:()=>{s.value="",t.value=[],c.value=[]}}}},ye={class:"company-search-selection"},ge={class:"mb-3"},he={for:"companySearch",class:"form-label"},_e=["placeholder"],Ce={class:"mt-3 mb-3"},Re={class:"d-flex justify-content-between align-items-center mb-2"},we={class:"mb-0"},Se={class:"badge bg-primary"},De={class:"list-group selected-companies-list"},ke={key:0,class:"text-muted small"},Te=["onClick"],Ie={class:"mt-3"},Me={class:"list-group search-results"},Ee={key:0,class:"text-center"},Ve={key:1,class:"text-muted small"},Ae={key:2,class:"text-muted small"},xe=["onClick","disabled"];function Pe(n,e,s,t,c,b){return u(),h("div",ye,[a("div",ge,[a("label",he,m(s.searchLabel),1),B(a("input",{type:"text",class:"form-control",id:"companySearch","onUpdate:modelValue":e[0]||(e[0]=l=>t.searchQuery=l),placeholder:s.searchPlaceholder},null,8,_e),[[j,t.searchQuery]])]),a("div",Ce,[a("div",Re,[a("h6",we,m(s.selectedLabel),1),a("span",Se,m(t.selectedCompanies.length),1)]),a("div",De,[t.selectedCompanies.length===0?(u(),h("div",ke," No companies selected ")):z("",!0),(u(!0),h(U,null,W(t.selectedCompanies,l=>(u(),h("div",{key:l.companyID,class:"list-group-item d-flex justify-content-between align-items-center"},[a("span",null,m(l.company_name),1),a("button",{type:"button",class:"btn btn-sm btn-outline-danger",onClick:r=>t.removeCompany(l)},e[1]||(e[1]=[a("i",{class:"fas fa-times"},null,-1)]),8,Te)]))),128))])]),a("div",Ie,[a("h6",null,m(s.resultsLabel),1),a("div",Me,[t.loading?(u(),h("div",Ee,e[2]||(e[2]=[a("div",{class:"spinner-border spinner-border-sm",role:"status"},null,-1),T(" Searching... ")]))):t.searchResults.length===0&&t.searchQuery.length<2?(u(),h("div",Ve," Enter at least 2 characters to search ")):t.searchResults.length===0?(u(),h("div",Ae," No companies found ")):z("",!0),(u(!0),h(U,null,W(t.searchResults,l=>(u(),h("div",{key:l.companyID,class:"list-group-item d-flex justify-content-between align-items-center"},[a("span",null,m(l.company_name),1),a("button",{type:"button",class:A(["btn btn-sm",t.isCompanySelected(l)?"btn-success disabled":"btn-outline-primary"]),onClick:r=>t.addCompany(l),disabled:t.isCompanySelected(l)},m(t.isCompanySelected(l)?"Added":"Add"),11,xe)]))),128))])])])}const Le=x(be,[["render",Pe],["__scopeId","data-v-e0c8f840"]]),Be={name:"ConfirmationModal",props:{modalId:{type:String,default:"confirmationModal"},title:{type:String,default:"Confirmation"},message:{type:String,default:"Are you sure you want to continue?"},confirmLabel:{type:String,default:"Yes, Continue"},cancelLabel:{type:String,default:"No, Cancel"}},emits:["confirm","cancel"],setup(n,{emit:e}){const s=d(null);$(()=>{const r=document.getElementById(n.modalId);r&&(s.value=new V(r))});const t=()=>{s.value&&s.value.show()},c=()=>{s.value&&s.value.hide()};return{modalRef:s,show:t,hide:c,onConfirm:()=>{e("confirm"),c()},onCancel:()=>{e("cancel")}}}},Ne=["id","aria-labelledby"],Fe={class:"modal-dialog modal-dialog-centered"},je={class:"modal-content"},Ue={class:"modal-header theme-header"},$e=["id"],Qe={class:"modal-body"},qe={class:"modal-footer"};function ze(n,e,s,t,c,b){return u(),h("div",{class:"modal fade",id:s.modalId,tabindex:"-1","aria-labelledby":s.modalId+"-label","aria-hidden":"true"},[a("div",Fe,[a("div",je,[a("div",Ue,[a("h5",{class:"modal-title",id:s.modalId+"-label"},m(s.title),9,$e),e[2]||(e[2]=a("button",{type:"button",class:"btn-close btn-close-white","data-bs-dismiss":"modal","aria-label":"Close"},null,-1))]),a("div",Qe,[a("p",null,m(s.message),1)]),a("div",qe,[a("button",{type:"button",class:"btn btn-secondary","data-bs-dismiss":"modal",onClick:e[0]||(e[0]=(...l)=>t.onCancel&&t.onCancel(...l))},m(s.cancelLabel),1),a("button",{type:"button",class:"btn btn-primary",onClick:e[1]||(e[1]=(...l)=>t.onConfirm&&t.onConfirm(...l))},m(s.confirmLabel),1)])])])],8,Ne)}const We=x(Be,[["render",ze],["__scopeId","data-v-40bcb875"]]),F=(n,e=!1)=>{if(!n)return"";const s=new Date(n);if(isNaN(s.getTime()))return"Invalid date";const t={year:"numeric",month:"short",day:"numeric"};return e&&(t.hour="2-digit",t.minute="2-digit"),s.toLocaleDateString("en-US",t)},Ye={name:"AdminReportTable",components:{ResponsiveTable:G,CompanySearchAndSelection:Le,ConfirmationModal:We},setup(){const n=d([]),e=d(!0),s=d(null),t=d(1),c=d(10),b=d(0),l=d(""),r=d(null),w=d(null),o=d({startTimestamp:"",endTimestamp:"",approval:!1}),R=d([]),y=[{key:"user",label:"Created By",sortable:!1},{key:"start_timestamp",label:"Start Date",sortable:!0},{key:"end_timestamp",label:"End Date",sortable:!0},{key:"approval",label:"Status",sortable:!0},{key:"companies",label:"Companies",sortable:!1}],g=async()=>{e.value=!0;try{const i={page:t.value,per_page:c.value,search:l.value},p=await D.getReportValidities(i);n.value=p.data,b.value=p.pagination.total}catch(i){s.value=i.message||"Failed to fetch report validities",f.danger("Error",s.value)}finally{e.value=!1}},C=i=>{t.value=i,g()},E=i=>{l.value=i,t.value=1,g()},H=async i=>{try{e.value=!0;const _=(await D.getReportValidity(i.reportValidityID)).companies.map(L=>`<li>${L.company_name}</li>`).join(""),v=document.getElementById("viewReportModal"),k=document.getElementById("viewReportModalBody");k.innerHTML=`
          <div class="report-details">
            <p><strong>Created By:</strong> ${i.user?i.user.fullname:"Unknown"}</p>
            <p><strong>Start Date:</strong> ${F(i.start_timestamp,!0)}</p>
            <p><strong>End Date:</strong> ${F(i.end_timestamp,!0)}</p>
            <p><strong>Status:</strong> ${i.approval?"Approved":"Pending"}</p>
            <p><strong>Companies:</strong></p>
            <ul>${_||"<li>No companies selected</li>"}</ul>
          </div>
        `,w.value||(w.value=new V(v)),w.value.show()}catch{f.danger("Error","Failed to load report details")}finally{e.value=!1}},O=async i=>{try{e.value=!0;const p=!i.approval;await D.updateReportValidity(i.reportValidityID,{approval:p});const _=n.value.findIndex(v=>v.reportValidityID===i.reportValidityID);_!==-1&&(n.value[_].approval=p),f.success("Success",`Report ${p?"approved":"marked as pending"} successfully`)}catch{f.danger("Error","Failed to update approval status")}finally{e.value=!1}},J=i=>{f.confirm("Delete Report","Are you sure you want to delete this report? This action cannot be undone.",async()=>{try{e.value=!0,await D.deleteReportValidity(i.reportValidityID),n.value=n.value.filter(p=>p.reportValidityID!==i.reportValidityID),f.success("Success","Report deleted successfully")}catch{f.danger("Error","Failed to delete report")}finally{e.value=!1}})},K=()=>{if(!o.value.startTimestamp||!o.value.endTimestamp){f.warning("Warning","Please fill in all required fields");return}if(R.value.length===0){f.warning("Warning","Please select at least one company");return}const i={startTimestamp:o.value.startTimestamp,endTimestamp:o.value.endTimestamp,approval:o.value.approval},p=R.value.map(_=>_.companyID);r.value&&r.value.hide(),setTimeout(()=>{const _=document.getElementById("confirmCreateReportModal");_&&(window.reportFormData={formData:i,selectedCompanyIds:p},(V.getInstance(_)||new V(_)).show())},300)},X=async()=>{var i,p,_;try{e.value=!0;const v=window.reportFormData||{};await D.createReportValidity({start_timestamp:((i=v.formData)==null?void 0:i.startTimestamp)||o.value.startTimestamp,end_timestamp:((p=v.formData)==null?void 0:p.endTimestamp)||o.value.endTimestamp,approval:((_=v.formData)==null?void 0:_.approval)||o.value.approval,company_ids:v.selectedCompanyIds||R.value.map(k=>k.companyID)}),delete window.reportFormData,r.value.hide(),g(),f.success("Success","Report created successfully"),Q()}catch(v){if(console.error("Report creation error details:",v),v.response&&v.response.status===422&&v.response.data.errors){const k=v.response.data.errors;let L="Validation failed:<br>";for(const ae in k)L+=`- ${k[ae].join("<br>- ")}<br>`;f.danger("Validation Error",L)}else f.danger("Error","Failed to create report: "+(v.message||"Unknown error"))}finally{e.value=!1}},Z=()=>{setTimeout(()=>{r.value&&r.value.show()},300)},ee=()=>{const i=document.getElementById("addReportModal");r.value||(r.value=new V(i),i.addEventListener("hidden.bs.modal",Q)),r.value.show()},te=()=>{t.value=1,s.value=null,g()},Q=()=>{o.value={startTimestamp:"",endTimestamp:"",approval:!1},R.value=[]};return $(()=>{g()}),{reportValidities:n,loading:e,error:s,columns:y,currentPage:t,perPage:c,totalItems:b,formData:o,selectedCompanies:R,handlePageChange:C,handleSearch:E,viewReportDetails:H,toggleApproval:O,confirmDelete:J,openAddReportModal:ee,handleCreateReport:K,submitCreateReport:X,closeConfirmationModal:Z,formatDate:F,refreshData:te}}},Ge={class:"report-table-container"},He={class:"card"},Oe={class:"card-header theme-header d-flex justify-content-between align-items-center"},Je={class:"card-body"},Ke={class:"d-flex align-items-center"},Xe={key:0},Ze={key:1},et={class:"badge bg-info"},tt={class:"d-flex justify-content-end"},at=["onClick"],ot=["onClick","title"],st=["onClick"],nt={class:"modal fade",id:"addReportModal",tabindex:"-1","aria-labelledby":"addReportModalLabel","aria-hidden":"true"},rt={class:"modal-dialog modal-lg"},lt={class:"modal-content"},it={class:"modal-body"},dt={class:"mb-3"},ct={class:"mb-3"},mt={class:"mb-3"},pt={class:"form-check"},ut={class:"modal-footer"};function vt(n,e,s,t,c,b){const l=I("ResponsiveTable"),r=I("CompanySearchAndSelection"),w=I("ConfirmationModal");return u(),h(U,null,[a("div",Ge,[a("div",He,[a("div",Oe,[e[10]||(e[10]=a("h5",{class:"mb-0"},"Report Validities",-1)),a("div",null,[a("button",{class:"btn btn-sm theme-btn-outline me-2",onClick:e[0]||(e[0]=(...o)=>t.refreshData&&t.refreshData(...o))},e[8]||(e[8]=[a("i",{class:"fas fa-sync-alt"},null,-1),a("span",{class:"d-none d-md-inline"},"Refresh",-1)])),a("button",{class:"btn btn-primary",onClick:e[1]||(e[1]=(...o)=>t.openAddReportModal&&t.openAddReportModal(...o))},e[9]||(e[9]=[a("i",{class:"fas fa-plus"},null,-1),a("span",{class:"d-none d-md-inline"},"Add Report",-1)]))])]),a("div",Je,[N(l,{columns:t.columns,items:t.reportValidities,loading:t.loading,"total-items":t.totalItems,"current-page":t.currentPage,"per-page":t.perPage,"server-side":!0,onPageChanged:t.handlePageChange,onSearch:t.handleSearch},{user:S(({item:o})=>[a("div",Ke,[o.user?(u(),h("div",Xe,[a("span",null,m(o.user.fullname),1)])):(u(),h("div",Ze,e[11]||(e[11]=[a("span",{class:"text-muted"},"Unknown",-1)])))])]),start_timestamp:S(({item:o})=>[T(m(t.formatDate(o.start_timestamp,!0)),1)]),end_timestamp:S(({item:o})=>[T(m(t.formatDate(o.end_timestamp,!0)),1)]),approval:S(({item:o})=>[a("span",{class:A(["badge",o.approval?"bg-success":"bg-warning"])},m(o.approval?"Approved":"Pending"),3)]),companies:S(({item:o})=>[a("span",et,m(o.reports?o.reports.length:0)+" Companies ",1)]),actions:S(({item:o})=>[a("div",tt,[a("button",{class:"btn btn-sm btn-outline-primary me-1",onClick:R=>t.viewReportDetails(o),title:"View Details"},e[12]||(e[12]=[a("i",{class:"fas fa-eye"},null,-1)]),8,at),a("button",{class:A(["btn btn-sm me-1",o.approval?"btn-outline-warning":"btn-outline-success"]),onClick:R=>t.toggleApproval(o),title:o.approval?"Mark as Pending":"Approve"},[a("i",{class:A(o.approval?"fas fa-times":"fas fa-check")},null,2)],10,ot),a("button",{class:"btn btn-sm btn-outline-danger",onClick:R=>t.confirmDelete(o),title:"Delete"},e[13]||(e[13]=[a("i",{class:"fas fa-trash"},null,-1)]),8,st)])]),_:1},8,["columns","items","loading","total-items","current-page","per-page","onPageChanged","onSearch"])])]),a("div",nt,[a("div",rt,[a("div",lt,[e[19]||(e[19]=a("div",{class:"modal-header theme-header"},[a("h5",{class:"modal-title",id:"addReportModalLabel"},"Add New Report"),a("button",{type:"button",class:"btn-close btn-close-white","data-bs-dismiss":"modal","aria-label":"Close"})],-1)),a("div",it,[a("form",{id:"addReportForm",onSubmit:e[6]||(e[6]=ne((...o)=>t.handleCreateReport&&t.handleCreateReport(...o),["prevent"]))},[a("div",dt,[e[14]||(e[14]=a("label",{for:"startTimestamp",class:"form-label"},"Start Date",-1)),B(a("input",{type:"datetime-local",class:"form-control",id:"startTimestamp","onUpdate:modelValue":e[2]||(e[2]=o=>t.formData.startTimestamp=o),required:""},null,512),[[j,t.formData.startTimestamp]])]),a("div",ct,[e[15]||(e[15]=a("label",{for:"endTimestamp",class:"form-label"},"End Date",-1)),B(a("input",{type:"datetime-local",class:"form-control",id:"endTimestamp","onUpdate:modelValue":e[3]||(e[3]=o=>t.formData.endTimestamp=o),required:""},null,512),[[j,t.formData.endTimestamp]])]),a("div",mt,[e[17]||(e[17]=a("label",{class:"form-label"},"Approval Status",-1)),a("div",pt,[B(a("input",{class:"form-check-input",type:"checkbox",id:"approvalStatus","onUpdate:modelValue":e[4]||(e[4]=o=>t.formData.approval=o)},null,512),[[re,t.formData.approval]]),e[16]||(e[16]=a("label",{class:"form-check-label",for:"approvalStatus"},"Approved",-1))])]),N(r,{selectedCompanies:t.selectedCompanies,"onUpdate:selectedCompanies":e[5]||(e[5]=o=>t.selectedCompanies=o)},null,8,["selectedCompanies"])],32)]),a("div",ut,[e[18]||(e[18]=a("button",{type:"button",class:"btn btn-secondary","data-bs-dismiss":"modal"},"Cancel",-1)),a("button",{type:"button",class:"btn btn-primary",onClick:e[7]||(e[7]=(...o)=>t.handleCreateReport&&t.handleCreateReport(...o))},"Create Report")])])])]),e[20]||(e[20]=se('<div class="modal fade" id="viewReportModal" tabindex="-1" aria-labelledby="viewReportModalLabel" aria-hidden="true" data-v-25694e2d><div class="modal-dialog modal-lg" data-v-25694e2d><div class="modal-content" data-v-25694e2d><div class="modal-header theme-header" data-v-25694e2d><h5 class="modal-title" id="viewReportModalLabel" data-v-25694e2d>Report Details</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close" data-v-25694e2d></button></div><div class="modal-body" id="viewReportModalBody" data-v-25694e2d></div><div class="modal-footer" data-v-25694e2d><button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-v-25694e2d>Close</button></div></div></div></div>',1))]),N(w,{modalId:"confirmCreateReportModal",title:"Confirm Report Creation",message:"Are you sure you want to create this report?",confirmLabel:"Yes, Create Report",cancelLabel:"No, Review Again",onConfirm:t.submitCreateReport,onCancel:t.closeConfirmationModal},null,8,["onConfirm","onCancel"])],64)}const ft=x(Ye,[["render",vt],["__scopeId","data-v-25694e2d"]]),bt={name:"SmeReportTable",components:{ResponsiveTable:G},setup(){const n=d([]),e=d(!0),s=d(null),t=d(1),c=d(10),b=d(0),l=d(""),r=[{key:"start_timestamp",label:"Start Date",sortable:!0},{key:"end_timestamp",label:"End Date",sortable:!0},{key:"approval",label:"Status",sortable:!0}],w=()=>{t.value=1,s.value=null,o()},o=async()=>{e.value=!0;try{const C={page:t.value,per_page:c.value,search:l.value},E=await D.getReportValidities(C);n.value=E.data,b.value=E.pagination.total}catch(C){s.value=C.message||"Failed to fetch report validities",f.danger("Error",s.value)}finally{e.value=!1}},R=C=>{t.value=C,o()},y=C=>{l.value=C,t.value=1,o()},g=async C=>{if(!C.approval){f.warning("Report Not Available","This report has not been approved yet.");return}try{e.value=!0,D.downloadReportPdf(C.reportValidityID),f.success("Success","Report download initiated.")}catch{f.danger("Error","Failed to download report")}finally{e.value=!1}};return $(()=>{o()}),{reportValidities:n,loading:e,error:s,columns:r,currentPage:t,perPage:c,totalItems:b,handlePageChange:R,handleSearch:y,downloadReport:g,formatDate:F,refreshData:w}}},yt={class:"report-table-container"},gt={class:"card"},ht={class:"card-header theme-header d-flex justify-content-between align-items-center"},_t={class:"card-body"},Ct={class:"d-flex justify-content-end"},Rt=["onClick","disabled","title"];function wt(n,e,s,t,c,b){const l=I("ResponsiveTable");return u(),h("div",yt,[a("div",gt,[a("div",ht,[e[2]||(e[2]=a("h5",{class:"mb-0"},"Available Reports",-1)),a("button",{class:"btn btn-sm theme-btn-outline",onClick:e[0]||(e[0]=(...r)=>t.refreshData&&t.refreshData(...r))},e[1]||(e[1]=[a("i",{class:"fas fa-sync-alt"},null,-1),T(),a("span",{class:"d-none d-md-inline"},"Refresh",-1)]))]),a("div",_t,[N(l,{columns:t.columns,items:t.reportValidities,loading:t.loading,"total-items":t.totalItems,"current-page":t.currentPage,"per-page":t.perPage,"server-side":!0,onPageChanged:t.handlePageChange,onSearch:t.handleSearch},{start_timestamp:S(({item:r})=>[T(m(t.formatDate(r.start_timestamp,!0)),1)]),end_timestamp:S(({item:r})=>[T(m(t.formatDate(r.end_timestamp,!0)),1)]),approval:S(({item:r})=>[a("span",{class:A(["badge",r.approval?"bg-success":"bg-warning"])},m(r.approval?"Approved":"Pending"),3)]),actions:S(({item:r})=>[a("div",Ct,[a("button",{class:"btn btn-sm btn-outline-primary",onClick:w=>t.downloadReport(r),disabled:!r.approval,title:r.approval?"Download Report":"Report not approved yet"},e[3]||(e[3]=[a("i",{class:"fas fa-download"},null,-1)]),8,Rt)])]),_:1},8,["columns","items","loading","total-items","current-page","per-page","onPageChanged","onSearch"])])])])}const St=x(bt,[["render",wt],["__scopeId","data-v-dea35fd9"]]),Dt={name:"ReportPage",components:{AdminReportTable:ft,SmeReportTable:St},setup(){const n=ie();return{isAdmin:le(()=>{const s=n.state.user;return s&&s.company&&s.company.company_type==="admin"})}}},kt={class:"report-page"};function Tt(n,e,s,t,c,b){const l=I("AdminReportTable"),r=I("SmeReportTable");return u(),h("div",kt,[e[0]||(e[0]=a("h1",{class:"mb-4"},"Reports",-1)),t.isAdmin?(u(),Y(l,{key:0})):(u(),Y(r,{key:1}))])}const At=x(Dt,[["render",Tt]]);export{At as default};
