import{H as C,_ as V,c as i,a as e,t as u,f as k,g as R,d as Q,b as f,e as U,o as d,w as L,v as A,y as le,F as O,i as S,n as w,r as g,B as ie,j as B,h as de,k as ce}from"./main-6HkEK7r2.js";import{S as me}from"./StatsCard-Daj1M7Ql.js";import{R as ue}from"./ResponsiveTable-DO6c7ISj.js";import{L as W}from"./LoadingSpinner-TtFArfCL.js";import{f as M}from"./formatter-CdZpJCmm.js";const P={fetchOrders(r={}){return C("/api/orders",{params:r})},fetchOrderStats(){return C("/api/orders/stats")},fetchOrderWithCheckpoints(r){return C(`/api/orders/${r}/checkpoints`)},getOrderById(r){return C(`/api/orders/${r}`)},createOrder(r){return C("/api/orders",{method:"post",data:r})},updateOrder(r,t){return C(`/api/orders/${r}`,{method:"put",data:t})},generateLocationQR(r,t){return C(`/api/qrcode/process/${r}/${t||0}`)}},ge={name:"OrderDetailModal",components:{LoadingSpinner:W},props:{modalId:{type:String,default:"orderDetailModal"},orderId:{type:[Number,String],default:null},orderData:{type:Object,default:null},showMainModalAfterQR:{type:Boolean,default:!0}},data(){return{loading:!1,order:null,error:null,qrCodeLoading:!1,qrCodeUrl:null,qrCodeLink:"",qrCodeLink:"",qrCodeTitle:"",qrCodeDescription:"",selectedOrderID:null,selectedLocationID:null,qrModal:null,mainModal:null,copySuccess:!1}},computed:{},watch:{orderId(r){r?this.orderData?(this.order=this.orderData,this.loading=!1):this.fetchOrderDetails(r):(this.order=null,this.error=null)},orderData(r){r&&(this.order=r,this.loading=!1,this.error=null)}},methods:{formatCurrency(r){return M.formatCurrency(r)},formatDateTime(r){return M.formatDate(r)},capitalizeFirstLetter(r){return r?r.charAt(0).toUpperCase()+r.slice(1):""},formatStatus(r){return r?r.split("_").map(t=>t.charAt(0).toUpperCase()+t.slice(1)).join(" "):"Unknown"},async fetchOrderDetails(r){var t,n;this.loading=!0,this.error=null,this.order=null;try{const o=await P.getOrderById(r);this.order=o.data}catch(o){console.error("Error fetching order details:",o),this.error="Failed to load order details. "+(((n=(t=o.response)==null?void 0:t.data)==null?void 0:n.message)||o.message)}finally{this.loading=!1}},getStatusColor(r){return{pending:"warning",processing:"info",shipped:"primary",delivered:"success",completed:"success",complete:"success",cancelled:"danger",waiting_delivery:"primary",paid:"success"}[r==null?void 0:r.toLowerCase()]||"secondary"},showQRCode(r,t,n=null){this.selectedOrderID=null,this.selectedLocationID=t,this.qrCodeLoading=!0,this.qrCodeUrl=null;const o=document.getElementById("qrCodeModal");if(n===null&&this.order&&this.order.locations){const p=this.order.locations.find(b=>b.locationID===t);p&&(n=p.companyID)}const m=Date.now(),v=m+2*60*60*1e3,h=`/api/qrcode/process/${t}/${n||0}?timestamp=${m}&expires=${v}`;this.qrCodeLink=`${window.location.origin}${h}`,this.qrCodeTitle="Location QR Code",this.selectedLocationID=`Location ${t}`,this.qrCodeDescription="Scan this QR code to process items at this location.",this.generateQRCode(this.qrCodeLink),this.qrModal&&(o&&(o.removeAttribute("inert"),o.removeAttribute("aria-hidden")),this.qrModal.show())},generateOrderVerificationQR(r){this.selectedOrderID=r,this.qrCodeLoading=!0,this.qrCodeUrl=null;const t=document.getElementById("qrCodeModal"),n=`/api/qrcode/verifies/${r}`;this.qrCodeLink=`${window.location.origin}${n}`,this.qrCodeTitle="Order Verification QR Code",this.qrCodeDescription="Scan this QR code to check the verification status of this order.",this.generateQRCode(this.qrCodeLink),this.qrModal&&(t&&(t.removeAttribute("inert"),t.removeAttribute("aria-hidden")),this.qrModal.show())},closeQRModal(){const r=document.getElementById("qrCodeModal");this.qrModal&&(r&&(r.setAttribute("inert",""),r.removeAttribute("aria-hidden")),this.qrModal.hide(),document.querySelectorAll(".modal-backdrop").forEach(n=>{n.classList.remove("show"),setTimeout(()=>{n.remove()},150)}))},generateQRCode(r){this.qrCodeLoading=!1;const t=document.createElement("canvas");QRCode.toCanvas(t,r,{width:250,margin:2,color:{dark:"#000000",light:"#ffffff"}},n=>{n?(console.error("Error generating QR code:",n),this.qrCodeUrl=null):(this.qrCodeUrl=t.toDataURL(),this.qrCodeLink="")})}},mounted(){this.orderId&&(this.orderData?this.order=this.orderData:this.fetchOrderDetails(this.orderId)),this.qrModal=new bootstrap.Modal(document.getElementById("qrCodeModal"),{backdrop:!0,keyboard:!0,focus:!0});const r=document.getElementById("qrCodeModal"),t=new MutationObserver(n=>{n.forEach(o=>{if(o.type==="attributes"&&o.attributeName==="aria-hidden"){const m=o.target;m.querySelector('button, a, input, select, textarea, [tabindex]:not([tabindex="-1"])')&&m.removeAttribute("aria-hidden")}})});r&&(t.observe(r,{attributes:!0}),r.addEventListener("hidden.bs.modal",n=>{document.querySelectorAll(".modal-backdrop").forEach(m=>{m.classList.remove("show"),setTimeout(()=>{m.remove()},150)})}))}},he={class:"modal fade",id:"qrCodeModal",tabindex:"-1","aria-labelledby":"qrCodeModalLabel",role:"dialog"},fe={class:"modal-dialog modal-dialog-centered"},pe={class:"modal-content"},_e={class:"modal-header theme-header"},ve={class:"modal-title",id:"qrCodeModalLabel"},be={class:"modal-body text-center"},ye={key:0,class:"my-3"},Ce={key:1},ke={class:"mb-3"},De=["src"],we={key:1,class:"text-danger"},qe={class:"mb-3"},xe={key:0,class:"mb-1"},Oe={key:1,class:"mt-2"},Me={class:"modal-footer"};function Ie(r,t,n,o,m,v){const h=R("LoadingSpinner");return d(),i("div",he,[e("div",fe,[e("div",pe,[e("div",_e,[e("h5",ve,u(m.qrCodeTitle||"QR Code"),1),t[2]||(t[2]=e("button",{type:"button",class:"btn-close","data-bs-dismiss":"modal","aria-label":"Close"},null,-1))]),e("div",be,[m.qrCodeLoading?(d(),i("div",ye,[k(h,{message:"Generating QR code..."})])):(d(),i("div",Ce,[e("div",ke,[m.qrCodeUrl?(d(),i("img",{key:0,src:m.qrCodeUrl,alt:"QR Code",class:"img-fluid secure-qr",style:{"max-width":"250px"},onContextmenu:t[0]||(t[0]=Q(()=>{},["prevent"]))},null,40,De)):(d(),i("p",we,"Failed to generate QR code."))]),e("div",qe,[m.selectedLocationID?(d(),i("p",xe,[t[3]||(t[3]=e("strong",null,"Location ID:",-1)),U(" "+u(m.selectedLocationID),1)])):f("",!0),m.qrCodeDescription?(d(),i("p",Oe,u(m.qrCodeDescription),1)):f("",!0)])]))]),e("div",Me,[e("button",{type:"button",class:"btn btn-secondary",onClick:t[1]||(t[1]=(...p)=>v.closeQRModal&&v.closeQRModal(...p))},"Back")])])])])}const Le=V(ge,[["render",Ie],["__scopeId","data-v-d52771aa"]]),Se={name:"OrderManagement",components:{StatsCard:me,ResponsiveTable:ue,LoadingSpinner:W,OrderDetailModal:Le},setup(){const r=de(),t=g(!0),n=g(null),o=g([]),m=g({total_orders:0,pending_orders:0,completed_orders:0,processing_orders:0,waiting_orders:0}),v=g(null),h=g(null),p=g(null),b=g({}),a=g(""),q=g(""),l=ie({from:"",to:""}),T=g("created_at"),_=g("desc"),y=g(1),z=g(10),D=g({current_page:1,last_page:1,per_page:10,total:0,from:1,to:10}),G=B(()=>{const s=[];if(D.value.last_page<=7)for(let c=1;c<=D.value.last_page;c++)s.push(c);else{let c=Math.max(1,y.value-2),x=Math.min(D.value.last_page,c+4);x-c<4&&(c=Math.max(1,x-4));for(let E=c;E<=x;E++)s.push(E)}return s}),J=s=>M.formatLargeNumber(s),H=s=>M.formatCurrency(s),K=s=>M.formatDate(s),X=s=>s?s.split("_").map(c=>c.charAt(0).toUpperCase()+c.slice(1)).join(" "):"Unknown",Y=s=>s&&{pending:"warning",processing:"info",complete:"success",waiting_verification:"primary",waiting_delivery:"primary",paid:"dark"}[s.toLowerCase()]||"secondary",Z=s=>{b.value={...b.value,[s]:!b.value[s]}},$=async(s,c)=>{try{p.value&&(v.value=null,h.value=null,p.value.showQRCode(null,s,c))}catch(x){console.error("Error generating QR code:",x)}},ee=s=>{window.open(`/awb/${s}`,"_blank")};let N=null;const te=()=>{clearTimeout(N),N=setTimeout(()=>{F()},500)},I=async()=>{try{t.value=!0,n.value=null;const s={page:y.value,per_page:z.value,search:a.value||null,status:q.value||null,sort_field:T.value,sort_direction:_.value};l.from&&(s.date_from=l.from),l.to&&(s.date_to=l.to);const c=await P.fetchOrders(s);console.log("Orders response:",JSON.stringify(c,null,4)),c.success&&c.data?(o.value=c.data,c.pagination&&(D.value=c.pagination)):(o.value=[],console.error("Unexpected response format:",c))}catch(s){console.error("Error fetching orders:",s),n.value=s.message||"Failed to load orders. Please try again later.",o.value=[]}finally{t.value=!1}},j=async()=>{try{const s=await P.fetchOrderStats();console.log("Order stats response:",JSON.stringify(s)),s&&typeof s=="object"?m.value={total_orders:s.total_orders||0,waiting_for_delivery_orders:s.waiting_for_delivery_orders||0,in_progress_orders:s.in_progress_orders||0,complete_orders:s.complete_orders||0}:console.error("Invalid stats format received:",s)}catch(s){console.error("Error fetching order stats:",s)}},oe=B(()=>{const s=r.getters.user;return s&&s.company?s.company.company_type==="broiler":!1}),re=B(()=>{const s=r.getters.user;return s&&s.company?s.company.company_type==="sme":!1}),F=()=>{y.value=1,I()},se=s=>{s<1||s>D.value.last_page||(y.value=s,I())},ae=()=>{y.value=1,n.value=null,I(),j()},ne=()=>{a.value="",q.value="",l.from="",l.to="",F()};return ce(()=>{I(),j()}),{loading:t,error:n,locations:o,orderStats:m,expandedOrders:b,searchQuery:a,statusFilter:q,dateRangeFilter:l,currentPage:y,getAllOrderItems:Re,pagination:D,paginationRange:G,formatLargeNumber:J,formatCurrency:H,formatDate:K,formatStatus:X,getStatusColor:Y,toggleOrder:Z,generateLocationQR:$,generateOrderQR:ee,debounceSearch:te,applyFilters:F,changePage:se,refreshData:ae,resetFilters:ne,selectedOrderId:v,selectedOrder:h,orderDetailModalRef:p,isBroilerCompany:oe,isSMECompany:re}}},Re=r=>{if(!r||!r.checkpoints)return[];const t=[];for(const n of r.checkpoints)n.items&&n.items.length&&t.push(...n.items);return t},Qe={class:"order-management"},Fe={key:0,class:"row mb-4"},Ee={class:"col-md-3 col-sm-6 mb-3"},Ae={class:"col-md-3 col-sm-6 mb-3"},Be={class:"col-md-3 col-sm-6 mb-3"},Ue={class:"col-md-3 col-sm-6 mb-3"},Pe={class:"card theme-card"},Te={class:"card-header d-flex justify-content-between align-items-center theme-header"},Ne={class:"card-body theme-body"},je={key:0,class:"alert alert-danger",role:"alert"},Ve={class:"mb-4"},We={class:"row g-2"},ze={class:"col-12 col-md-6 col-lg-4"},Ge={class:"input-group"},Je={class:"col-12 col-md-6 col-lg-2"},He={class:"col-12 col-sm-6 col-lg-3"},Ke={class:"input-group"},Xe={class:"col-12 col-sm-6 col-lg-3"},Ye={class:"input-group"},Ze={class:"d-flex justify-content-end mt-2"},$e={key:1,class:"text-center py-5"},et={key:2,class:"text-center py-5"},tt={key:3},ot={class:"card theme-inner-card"},rt={class:"card-header theme-card-header"},st={class:"d-flex flex-column flex-md-row justify-content-between align-items-md-center"},at={class:"mb-2 mb-md-0"},nt={class:"badge theme-badge-location me-2"},lt={class:"d-flex justify-content-between align-items-center"},it={class:"badge theme-badge-primary me-3"},dt=["onClick"],ct={class:"card-body p-0"},mt={class:"table-responsive"},ut={class:"table table-hover mb-0 theme-table"},gt={class:"text-center"},ht=["onClick","aria-expanded"],ft={key:0},pt={colspan:"6",class:"p-0"},_t={class:"p-3 theme-details"},vt={class:"table-responsive"},bt={class:"table table-sm table-bordered theme-inner-table"},yt={class:"theme-table-header"},Ct={key:0,style:{width:"auto","white-space":"nowrap"},class:"text-center"},kt={class:"d-flex align-items-center"},Dt={class:"fw-bold"},wt={class:"text-muted"},qt={key:0,class:"text-center"},xt=["onClick"],Ot={key:4,class:"d-flex justify-content-between align-items-center mt-4 theme-pagination-container"},Mt={class:"theme-pagination-text"},It={"aria-label":"Order pagination"},Lt={class:"pagination mb-0"},St=["onClick"];function Rt(r,t,n,o,m,v){const h=R("StatsCard"),p=R("LoadingSpinner"),b=R("OrderDetailModal");return d(),i("div",Qe,[t[30]||(t[30]=e("h1",{class:"mb-4"},"Order Management",-1)),o.isSMECompany?(d(),i("div",Fe,[e("div",Ee,[k(h,{title:"Total Orders",count:o.formatLargeNumber(o.orderStats.total_orders),icon:"fas fa-shopping-cart","bg-color":"bg-primary"},null,8,["count"])]),e("div",Ae,[k(h,{title:"Waiting For Delivery",count:o.formatLargeNumber(o.orderStats.waiting_for_delivery_orders),icon:"fas fa-hourglass-half","bg-color":"bg-warning"},null,8,["count"])]),e("div",Be,[k(h,{title:"In Progress",count:o.formatLargeNumber(o.orderStats.in_progress_orders),icon:"fas fa-cogs","bg-color":"bg-info"},null,8,["count"])]),e("div",Ue,[k(h,{title:"Complete",count:o.formatLargeNumber(o.orderStats.complete_orders),icon:"fas fa-check-circle","bg-color":"bg-success"},null,8,["count"])])])):f("",!0),e("div",Pe,[e("div",Te,[t[13]||(t[13]=e("h5",{class:"mb-0"},"Orders by Location",-1)),e("button",{class:"btn btn-sm theme-btn-outline",onClick:t[0]||(t[0]=(...a)=>o.refreshData&&o.refreshData(...a))},t[12]||(t[12]=[e("i",{class:"fas fa-sync-alt"},null,-1),U(" Refresh ")]))]),e("div",Ne,[o.error?(d(),i("div",je,u(o.error),1)):f("",!0),e("div",Ve,[e("div",We,[e("div",ze,[e("div",Ge,[L(e("input",{type:"text",class:"form-control",placeholder:"Search orders...","onUpdate:modelValue":t[1]||(t[1]=a=>o.searchQuery=a),onInput:t[2]||(t[2]=(...a)=>o.debounceSearch&&o.debounceSearch(...a))},null,544),[[A,o.searchQuery]]),t[14]||(t[14]=e("button",{class:"btn btn-outline-secondary",type:"button"},[e("i",{class:"fas fa-search"})],-1))])]),e("div",Je,[L(e("select",{class:"form-select","onUpdate:modelValue":t[3]||(t[3]=a=>o.statusFilter=a),onChange:t[4]||(t[4]=(...a)=>o.applyFilters&&o.applyFilters(...a))},t[15]||(t[15]=[e("option",{value:""},"All Statuses",-1),e("option",{value:"waiting_for_delivery"},"Waiting for Delivery",-1),e("option",{value:"in_progress"},"In Progress",-1),e("option",{value:"complete"},"Complete",-1)]),544),[[le,o.statusFilter]])]),e("div",He,[e("div",Ke,[t[16]||(t[16]=e("span",{class:"input-group-text"},"From",-1)),L(e("input",{type:"date",class:"form-control","onUpdate:modelValue":t[5]||(t[5]=a=>o.dateRangeFilter.from=a),onChange:t[6]||(t[6]=(...a)=>o.applyFilters&&o.applyFilters(...a))},null,544),[[A,o.dateRangeFilter.from]])])]),e("div",Xe,[e("div",Ye,[t[17]||(t[17]=e("span",{class:"input-group-text"},"To",-1)),L(e("input",{type:"date",class:"form-control","onUpdate:modelValue":t[7]||(t[7]=a=>o.dateRangeFilter.to=a),onChange:t[8]||(t[8]=(...a)=>o.applyFilters&&o.applyFilters(...a))},null,544),[[A,o.dateRangeFilter.to]])])])]),e("div",Ze,[e("button",{class:"btn btn-sm btn-outline-secondary",onClick:t[9]||(t[9]=(...a)=>o.resetFilters&&o.resetFilters(...a))},t[18]||(t[18]=[e("i",{class:"fas fa-times"},null,-1),U(" Clear Filters ")]))])]),o.loading?(d(),i("div",$e,[k(p)])):f("",!0),!o.loading&&(!o.locations||o.locations.length===0)?(d(),i("div",et,t[19]||(t[19]=[e("div",{class:"mb-3"},[e("i",{class:"fas fa-box-open fa-4x text-muted"})],-1),e("h5",{class:"text-muted"},"No orders found",-1),e("p",{class:"text-muted"},"Try adjusting your filters or check back later.",-1)]))):f("",!0),!o.loading&&o.locations&&o.locations.length>0?(d(),i("div",tt,[(d(!0),i(O,null,S(o.locations,(a,q)=>(d(),i("div",{key:a.locationID,class:"location-card mb-4"},[e("div",ot,[e("div",rt,[e("div",st,[e("div",at,[e("span",nt,u(a.location_type),1),e("strong",null,u(a.company_address),1)]),e("div",lt,[e("span",it,u(a.orders.length)+" orders",1),e("button",{class:"btn btn-sm btn-primary",onClick:l=>o.generateLocationQR(a.locationID,a.companyID||0),title:"Generate QR Code for this location"},t[20]||(t[20]=[e("i",{class:"fas fa-qrcode"},null,-1)]),8,dt)])])]),e("div",ct,[e("div",mt,[e("table",ut,[t[27]||(t[27]=e("thead",{class:"theme-table-header"},[e("tr",null,[e("th",{scope:"col",style:{width:"50px"}}),e("th",{scope:"col"},"Order ID"),e("th",{scope:"col"},"Status"),e("th",{scope:"col"},"Date"),e("th",{scope:"col"},"Customer")])],-1)),e("tbody",null,[(d(!0),i(O,null,S(a.orders,(l,T)=>(d(),i(O,{key:l.orderID},[e("tr",{class:w(["theme-list-item",{"theme-list-item-active":o.expandedOrders[l.orderID]}])},[e("td",gt,[e("button",{class:"btn btn-sm btn-link p-0",onClick:_=>o.toggleOrder(l.orderID),"aria-expanded":o.expandedOrders[l.orderID]?"true":"false"},[e("i",{class:w(["fas theme-icon",o.expandedOrders[l.orderID]?"fa-chevron-down":"fa-chevron-right"])},null,2)],8,ht)]),e("td",null,[e("strong",null,"#"+u(l.orderID),1)]),e("td",null,[e("span",{class:w(["badge",`theme-badge-${o.getStatusColor(l.calculated_status||l.order_status)}`])},u(o.formatStatus(l.calculated_status||l.order_status)),3)]),e("td",null,u(o.formatDate(l.created_at)),1),e("td",null,u(l.user?l.user.fullname||l.user.email:"N/A"),1)],2),o.expandedOrders[l.orderID]?(d(),i("tr",ft,[e("td",pt,[e("div",_t,[t[26]||(t[26]=e("h6",{class:"mb-3 theme-subtitle"},"Order Items",-1)),e("div",vt,[e("table",bt,[e("thead",yt,[e("tr",null,[t[22]||(t[22]=e("th",{style:{width:"auto","white-space":"nowrap"}},"Cart ID",-1)),t[23]||(t[23]=e("th",null,"Item",-1)),t[24]||(t[24]=e("th",{style:{width:"auto","white-space":"nowrap"}},"Quantity",-1)),o.isBroilerCompany?(d(),i("th",Ct,t[21]||(t[21]=[e("span",{class:"d-none d-sm-inline"},"AWB Download",-1),e("span",{class:"d-inline d-sm-none"},"AWB",-1)]))):f("",!0)])]),e("tbody",null,[(d(!0),i(O,null,S(o.getAllOrderItems(l),_=>(d(),i("tr",{key:`${l.orderID}-${_.cartID}-${_.itemID}`},[e("td",null,u(_.cartID),1),e("td",null,[e("div",kt,[e("div",null,[e("div",Dt,u(_.item_name),1),e("small",wt,u(_.measurement_value)+" "+u(_.measurement_type),1)])])]),e("td",null,u(_.quantity),1),o.isBroilerCompany?(d(),i("td",qt,[e("button",{class:"btn btn-sm btn-outline-primary",onClick:y=>o.generateOrderQR(l.orderID),title:"Download AWB Waybill"},t[25]||(t[25]=[e("i",{class:"fas fa-file-download"},null,-1),e("span",{class:"d-inline d-sm-none ms-1"},"AWB",-1)]),8,xt)])):f("",!0)]))),128))])])])])])])):f("",!0)],64))),128))])])])])])]))),128))])):f("",!0),!o.loading&&o.locations&&o.locations.length>0?(d(),i("div",Ot,[e("div",null,[e("span",Mt,"Showing "+u(o.pagination.from||1)+"-"+u(o.pagination.to||o.locations.length)+" of "+u(o.pagination.total||o.locations.length),1)]),e("nav",It,[e("ul",Lt,[e("li",{class:w(["page-item",{disabled:o.currentPage<=1||o.loading}])},[e("a",{class:"page-link theme-pagination-link",href:"#",onClick:t[10]||(t[10]=Q(a=>!o.loading&&o.changePage(o.currentPage-1),["prevent"]))},t[28]||(t[28]=[e("i",{class:"fas fa-chevron-left"},null,-1)]))],2),(d(!0),i(O,null,S(o.paginationRange,a=>(d(),i("li",{key:a,class:w(["page-item",{active:a===o.currentPage,disabled:o.loading}])},[e("a",{class:"page-link theme-pagination-link",href:"#",onClick:Q(q=>!o.loading&&o.changePage(a),["prevent"])},u(a),9,St)],2))),128)),e("li",{class:w(["page-item",{disabled:o.currentPage>=o.pagination.last_page||o.loading}])},[e("a",{class:"page-link theme-pagination-link",href:"#",onClick:t[11]||(t[11]=Q(a=>!o.loading&&o.changePage(o.currentPage+1),["prevent"]))},t[29]||(t[29]=[e("i",{class:"fas fa-chevron-right"},null,-1)]))],2)])])])):f("",!0)])]),k(b,{ref:"orderDetailModalRef","order-id":o.selectedOrderId,"order-data":o.selectedOrder,"modal-id":"orderPageDetailModal","show-main-modal-after-QR":!1},null,8,["order-id","order-data"])])}const Ut=V(Se,[["render",Rt],["__scopeId","data-v-fbbfb454"]]);export{Ut as default};
